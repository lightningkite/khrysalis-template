// Generated by Khrysalis TypeScript converter - this file will be overwritten.
// File: vg/MapDemoVG.kt
// Package: com.lightningkite.butterflytemplate.vg
import { ObservableProperty } from 'butterfly/dist/observables/ObservableProperty'
import { xEditTextBindString } from 'butterfly/dist/observables/binding/EditText.binding'
import { xTextViewBindString } from 'butterfly/dist/observables/binding/TextView.binding'
import { xObservablePropertyMap } from 'butterfly/dist/observables/TransformedObservableProperty'
import { xObservablePropertyObservableNNGet } from 'butterfly/dist/observables/ObservableProperty.ext'
import { GeoCoordinate } from 'butterfly/dist/location/GeoCoordinate'
import { ViewGenerator } from 'butterfly/dist/views/ViewGenerator'
import { ObservableInput, SubscriptionLike } from 'rxjs'
import { xDisposableUntil, xViewRemovedGet } from 'butterfly/dist/rx/DisposeCondition.ext'
import { StandardObservableProperty } from 'butterfly/dist/observables/StandardObservableProperty'
import { xRecyclerViewBind } from 'butterfly/dist/observables/binding/RecyclerView.binding'
import { debounceTime as rxDebounceTime, distinctUntilChanged as rxDistinctUntilChanged, flatMap as rxFlatMap } from 'rxjs/operators'
import { MapDemoXml } from '../layout/MapDemoXml'
import { ComponentTextXml } from '../layout/ComponentTextXml'
import { xActivityAccessGeocode } from 'butterfly/dist/location/Geocoding'
import { xMapViewBindSelect } from 'butterfly-maps-google/dist/MapView.bind'
import { GeoAddress } from 'butterfly/dist/location/GeoAddress'

//! Declares com.lightningkite.butterflytemplate.vg.MapDemoVG
export class MapDemoVG extends ViewGenerator {
    public constructor() {
        super();
        this.text = new StandardObservableProperty<string>("", undefined);
        this.position = new StandardObservableProperty<(GeoCoordinate | null)>(null, undefined);
        this.options = new StandardObservableProperty<Array<GeoAddress>>([], undefined);
    }
    
    //! Declares com.lightningkite.butterflytemplate.vg.MapDemoVG.title
    public get title(): string { return "Map Demo"; }
    
    
    public readonly text: StandardObservableProperty<string>;
    
    public readonly position: StandardObservableProperty<(GeoCoordinate | null)>;
    
    public readonly options: StandardObservableProperty<Array<GeoAddress>>;
    
    
    public generate(dependency: Window): HTMLElement {
        const xml = new MapDemoXml();
        
        const view = xml.setup(dependency);
        
        
        xMapViewBindSelect(xml.map, dependency, this.position, undefined, undefined, undefined);
        xEditTextBindString(xml.select, this.text);
        xRecyclerViewBind<GeoAddress>(xml.options, this.options, new GeoAddress(undefined, undefined, undefined, undefined, undefined, undefined, undefined, undefined, undefined), (obs: ObservableProperty<GeoAddress>): HTMLElement => {
                const xml = new ComponentTextXml();
                
                const view = xml.setup(dependency);
                
                xTextViewBindString(xml.label, xObservablePropertyMap<GeoAddress, string>(obs, (it: GeoAddress): string => it.oneLine(undefined, undefined)));
                xml.xmlRoot.onclick = (_ev) => { _ev.stopPropagation(); 
                    this.position.value = obs.value.coordinate;
                };
                return view;
        });
        
        xDisposableUntil<SubscriptionLike>(xObservablePropertyObservableNNGet(this.text).pipe(rxDebounceTime(1000)).pipe(rxDistinctUntilChanged()).pipe(rxFlatMap((it: string): ObservableInput<Array<GeoAddress>> => xActivityAccessGeocode(dependency, it, undefined))).subscribe((it: Array<GeoAddress>): void => {
                    this.options.value = it;
        }, undefined, undefined), xViewRemovedGet(view));
        
        return view;
    }
}

